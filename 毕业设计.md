# Python爬取疫情数据自动更新及可视化

# 一 项目概述

## 1.1 涉及技术

1. Python网络爬虫
2. 使用Python与MariaDB数据库交互
3. 使用Flask构建Web项目
4. 基于Echrats数据可视化展示
5. 在Linux上部署Web项目及爬虫

## 1.2 项目架构

1. 数据获取
2. 数据持久化
   1. mairadb
3. flask搭建Web后台
4. 数据可视化
   1. h5
   2. echarts

## 1.3 环境准备

- Python 3.x
- MariaDB
- PyCharm
- Jupter notebook
- Hbiuld
  - 可视化部分使用
- Linux主机
  - Web部署阶段使用

# 二 数据获取

## 2.1 爬虫概述

## 2.2 爬取腾讯疫情数据

### 分析与处理

dict_all["data"]下json结构:

```
dict_all["data"]
    'chinaDayAddList',
    'chinaDayList',
    'diseaseh5Shelf',
        'lastUpdateTime', 
        'chinaTotal', 
        'chinaAdd', 
        'isShowAdd', 
        'showAddSwitch', 
        'areaTree'  # 这里是个列表,第一个是中国
        	'name', 
        	'today', 
        	'total', 
        	'children'  # 这里是中国的各个省和行政区
        		'name', 
        		'adcode', 
        		'date', 
        		'today', 
        		'total', 
        		'children'  # 下面是各个省下市区,依次类推数据结构
    'localCityNCOVDataList', 
    'nowConfirmStatis', 
    'provinceCompare'
```

###   数据永久化

这次选择了mairadb数据库,密码mariaBugsong

#### 1. 数据库安装和初始化

#### 2. 创建数据库以及数据表

**创建历史数据库**

```sql
CREATE TABLE `history` (
  `ds` datetime NOT NULL COMMENT '日期',
  `confirm` int(11) DEFAULT NULL COMMENT '累计确诊',
  `confirm_add` int(11) DEFAULT NULL COMMENT '当日新增确诊',
  `suspect` int(11) DEFAULT NULL COMMENT '剩余疑似',
  `suspect_add` int(11) DEFAULT NULL COMMENT '当日新增疑似',
  `heal` int(11) DEFAULT NULL COMMENT '累计治愈',
  `heal_add` int(11) DEFAULT NULL COMMENT '当日新增治愈',
  `dead` int(11) DEFAULT NULL COMMENT '累计死亡',
  `dead_add` int(11) DEFAULT NULL COMMENT '当日累计死亡',
  PRIMARY KEY (`ds`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
```

**创建细节数据**

```sql
CREATE TABLE `details` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `update_time` datetime DEFAULT NULL COMMENT '数据最后更新时间',
  `province` varchar(50) DEFAULT NULL COMMENT '省',
  `city` varchar(50) DEFAULT NULL COMMENT '市',
  `confirm` int(11) DEFAULT NULL COMMENT '累计确诊',
  `confirm_add` int(11) DEFAULT NULL COMMENT '新增确诊',
  `heal` int(11) DEFAULT NULL COMMENT '累计治愈',
  `dead` int(11) DEFAULT NULL COMMENT '累计死亡',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
```



#### 3. Python链接数据库

此处使用`pymysql`模块,由于本项目的服务器暂时搭建在本机,所以我们

主机填写`127.0.0.1`,

端口填写`3306`

其余可以根据自己的设置进行补充

```python
def get_connect(link_conf):
    """
    传入用户的数据库配置,返回一个链接和游标
    :param link_conf:
    :return: (链接,游标)
    """

    # 创建链接
    connect = pymysql.connect(host=link_conf["host"],
                              port=link_conf["port"],
                              user=link_conf["user"],
                              password=link_conf["password"],
                              db=link_conf["db"],
                              charset=link_conf["charset"])
    # 创建游标
    cursor = connect.cursor()
    return connect, cursor


def close_connect(conn, csr):
    """
    传入将链接和游标进行顺序关闭
    :param conn: 链接
    :param csr: 游标
    :return: none
    """
    if csr:
        csr.close()
    if conn:
        conn.close()

        
link_config = {
    "host": "127.0.0.1",
    "port": 3306,
    "user": "root",
    "password": "mariaBugsong",
    "db": "bugsong",
    "charset": "utf8mb4"
}
```

#### Python写入数据库

**详细数据写入**

```python
def insert_details(get_tencent_data, get_connect_ret, close_conn):
    """
    插入最新疫情数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    connect = None
    try:
        dic = get_tencent_data()[0]  # 读取历史数据字典
        print(f"{time.asctime()}开始插入历史数据")
        connect, cursor = get_connect_ret  # 此处接收的是函数的返回值,为一个元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        for k, v in dic.items():
            # item 格式 {'2022-01-03':{'confirm':41,'suspect':0,'heal':0,'dead':1}}
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        connect.commit()  # 只要不是单纯查询都得提交事务
        print(f"{time.asctime()}插入历史数据完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(connect, cursor)
```

**详细数据更新**

```python
def insert_details(get_tencent_data, get_connect_ret, close_conn):
    """
    插入最新疫情数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    connect = None
    try:
        dic = get_tencent_data()[0]  # 读取历史数据字典
        print(f"{time.asctime()}开始插入历史数据")
        connect, cursor = get_connect_ret  # 此处接收的是函数的返回值,为一个元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        for k, v in dic.items():
            # item 格式 {'2022-01-03':{'confirm':41,'suspect':0,'heal':0,'dead':1}}
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        connect.commit()  # 只要不是单纯查询都得提交事务
        print(f"{time.asctime()}插入历史数据完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(connect, cursor)
```

**历史数据写入**

```python
def insert_history(get_tencent_data, get_connect_ret, close_conn):
    """
    初次插入历史数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    conn = None
    try:
        dic = get_tencent_data()[0]
        print(f"{time.asctime()}开始插入历史数据")
        conn, cursor = get_connect_ret
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"
        for k, v in dic.items():
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        conn.commit()  # 插入后提交
        print(f"{time.asctime()}插入历史数据完毕!")
    except:
        traceback.print_exc()
    finally:
        close_conn(conn, cursor)
```

**历史数据更新**

```python
def update_history(get_tencent_data, get_connect_ret, close_conn):
    """
    更新历史数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    conn = None
    try:
        dic = get_tencent_data()[0]  # 历史字典数据
        print(f"{time.asctime()}开始更新历史数据")
        conn, cursor = get_connect_ret  # 返回值元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        sql_query = "select confirm from history where ds=%s"
        for k, v in dic.items():
            if not cursor.execute(sql_query, k):
                cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                     v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        conn.commit()  # 提交事务
        print(f"{time.asctime()}历史数据更新完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(conn, cursor)
```



# 三 Web程序开发

# 四 项目部署
