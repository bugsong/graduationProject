# Python爬取疫情数据自动更新及可视化

# 一 项目概述

非常适合练手的前后段结合项目

## 1.1 涉及技术

1. Python网络爬虫
2. 使用Python与MariaDB数据库交互
3. 使用Flask构建Web项目
4. 基于Echrats数据可视化展示
5. 在Linux上部署Web项目及爬虫

## 1.2 项目架构

1. 数据获取
   1. Python爬虫

2. 数据持久化
   1. MairaDB
3. flask搭建Web后台
4. 数据可视化
   1. H5
   2. ECharts

## 1.3 环境准备

- Python 3.x
- PyCharm
- Visual Studio Code
  - 可视化部分使用,方便编辑,如果你可以使用其他顺手工具也无妨
- Linux主机
  - MariaDB
  - Python 3.x
  - Web部署阶段使用


# 二 数据获取

## 2.1 爬虫概述

## 2.2 爬取腾讯疫情数据

优点是腾讯放开了部分的疫情历史数据.

### 2.2.1 分析与处理

dict_all["data"]下json结构:

```
dict_all["data"]
    'chinaDayAddList',
    'chinaDayList',
    'diseaseh5Shelf',
        'lastUpdateTime', 
        'chinaTotal', 
        'chinaAdd', 
        'isShowAdd', 
        'showAddSwitch', 
        'areaTree'  # 这里是个列表,第一个是中国
        	'name', 
        	'today', 
        	'total', 
        	'children'  # 这里是中国的各个省和行政区
        		'name', 
        		'adcode', 
        		'date', 
        		'today', 
        		'total', 
        		'children'  # 下面是各个省下市区,依次类推数据结构
    'localCityNCOVDataList', 
    'nowConfirmStatis', 
    'provinceCompare'
```

#### 数据的获取

```python
def get_tencent_data():
    """
    爬取腾讯疫情平台数据
    :return: 返回历史数据和当日详细数据
    """
    url = "https://api.inews.qq.com/newsqa/v1/query/inner/publish/modules/list?" \
          "modules=localCityNCOVDataList,diseaseh5Shelf," \
          "chinaDayList,chinaDayAddList,nowConfirmStatis,provinceCompare"
    headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:100.0) Gecko/20100101 Firefox/100.0", }
    response = requests.post(url=url, headers=headers)
    data_all = json.loads(response.text)  # json字符串转换为字典

    history = {}  # 承接历史数据
    for i in data_all["data"]["chinaDayList"]:
        ds = "2022." + i["date"]  # 网站数据类型为05.24  所以用来拼接成日期
        tup = time.strptime(ds, "%Y.%m.%d")
        ds = time.strftime("%Y-%m-%d", tup)  # 改变时间格式,以便插入数据库,datetime类型
        confirm = i["confirm"]
        suspect = i["suspect"]
        heal = i["heal"]
        dead = i["dead"]
        history[ds] = {"confirm": confirm, "suspect": suspect, "heal": heal, "dead": dead}
        # print(history[ds])  # 获取没有问题,问题应该出在了写入

    for t in data_all["data"]["chinaDayAddList"]:
        ds = "2022." + i["date"]
        tup = time.strptime(ds, "%Y.%m.%d")
        ds = time.strftime("%Y-%m-%d", tup)  # 改变时间格式,以便插入数据库,datetime类型
        confirm = t["confirm"]
        suspect = t["suspect"]
        heal = t["heal"]
        dead = t["dead"]
        history[ds].update({"confirm_add": confirm, "suspect_add": suspect, "heal_add": heal, "dead_add": dead})

    details = []  # 当日详细数据
    update_time = data_all["data"]["diseaseh5Shelf"]["lastUpdateTime"]
    data_country = data_all["data"]["diseaseh5Shelf"]["areaTree"]  # 各个国家数据
    data_province = data_country[0]["children"]  # 中国各省

    for pro_infos in data_province:
        province = pro_infos["name"]  # 省名fixed
        for city_infos in pro_infos["children"]:
            city = city_infos["name"]  # fixed
            confirm = city_infos["total"]["confirm"]
            confirm_add = city_infos["today"]["confirm"]
            heal = city_infos["total"]["heal"]
            dead = city_infos["total"]["dead"]
            details.append([update_time, province, city, confirm, confirm_add, heal, dead])
    return history, details
```



###   2.2.2数据永久化

这次选择了mairadb数据库,密码mariaBugsong

#### 1. 数据库安装和初始化



#### 2. 创建数据库以及数据表

**创建历史数据库**

```sql
CREATE TABLE `history` (
  `ds` datetime NOT NULL COMMENT '日期',
  `confirm` int(11) DEFAULT NULL COMMENT '累计确诊',
  `confirm_add` int(11) DEFAULT NULL COMMENT '当日新增确诊',
  `suspect` int(11) DEFAULT NULL COMMENT '剩余疑似',
  `suspect_add` int(11) DEFAULT NULL COMMENT '当日新增疑似',
  `heal` int(11) DEFAULT NULL COMMENT '累计治愈',
  `heal_add` int(11) DEFAULT NULL COMMENT '当日新增治愈',
  `dead` int(11) DEFAULT NULL COMMENT '累计死亡',
  `dead_add` int(11) DEFAULT NULL COMMENT '当日累计死亡',
  PRIMARY KEY (`ds`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
```

**创建细节数据**

```sql
CREATE TABLE `details` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `update_time` datetime DEFAULT NULL COMMENT '数据最后更新时间',
  `province` varchar(50) DEFAULT NULL COMMENT '省',
  `city` varchar(50) DEFAULT NULL COMMENT '市',
  `confirm` int(11) DEFAULT NULL COMMENT '累计确诊',
  `confirm_add` int(11) DEFAULT NULL COMMENT '新增确诊',
  `heal` int(11) DEFAULT NULL COMMENT '累计治愈',
  `dead` int(11) DEFAULT NULL COMMENT '累计死亡',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
```



#### 3. Python链接数据库

此处使用`pymysql`模块,由于本项目的服务器暂时搭建在本机,所以我们

主机填写`127.0.0.1`,

端口填写`3306`

其余可以根据自己的设置进行补充

```python
def get_connect(link_conf):
    """
    传入用户的数据库配置,返回一个链接和游标
    :param link_conf:
    :return: (链接,游标)
    """

    # 创建链接
    connect = pymysql.connect(host=link_conf["host"],
                              port=link_conf["port"],
                              user=link_conf["user"],
                              password=link_conf["password"],
                              db=link_conf["db"],
                              charset=link_conf["charset"])
    # 创建游标
    cursor = connect.cursor()
    return connect, cursor


def close_connect(conn, csr):
    """
    传入将链接和游标进行顺序关闭
    :param conn: 链接
    :param csr: 游标
    :return: none
    """
    if csr:
        csr.close()
    if conn:
        conn.close()

        
link_config = {
    "host": "127.0.0.1",
    "port": 3306,
    "user": "root",
    "password": "***********",
    "db": "bugsong",
    "charset": "utf8mb4"
}
```

#### 4. Python写入数据库

**详细数据写入**

```python
def insert_details(get_tencent_data, get_connect_ret, close_conn):
    """
    插入最新疫情数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    connect = None
    try:
        dic = get_tencent_data()[0]  # 读取历史数据字典
        print(f"{time.asctime()}开始插入历史数据")
        connect, cursor = get_connect_ret  # 此处接收的是函数的返回值,为一个元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        for k, v in dic.items():
            # item 格式 {'2022-01-03':{'confirm':41,'suspect':0,'heal':0,'dead':1}}
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        connect.commit()  # 只要不是单纯查询都得提交事务
        print(f"{time.asctime()}插入历史数据完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(connect, cursor)
```

**详细数据更新**

```python
def insert_details(get_tencent_data, get_connect_ret, close_conn):
    """
    插入最新疫情数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    connect = None
    try:
        dic = get_tencent_data()[0]  # 读取历史数据字典
        print(f"{time.asctime()}开始插入历史数据")
        connect, cursor = get_connect_ret  # 此处接收的是函数的返回值,为一个元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        for k, v in dic.items():
            # item 格式 {'2022-01-03':{'confirm':41,'suspect':0,'heal':0,'dead':1}}
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        connect.commit()  # 只要不是单纯查询都得提交事务
        print(f"{time.asctime()}插入历史数据完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(connect, cursor)
```

**历史数据写入**

```python
def insert_history(get_tencent_data, get_connect_ret, close_conn):
    """
    初次插入历史数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    conn = None
    try:
        dic = get_tencent_data()[0]
        print(f"{time.asctime()}开始插入历史数据")
        conn, cursor = get_connect_ret
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"
        for k, v in dic.items():
            cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                 v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        conn.commit()  # 插入后提交
        print(f"{time.asctime()}插入历史数据完毕!")
    except:
        traceback.print_exc()
    finally:
        close_conn(conn, cursor)
```

**历史数据更新**

```python
def update_history(get_tencent_data, get_connect_ret, close_conn):
    """
    更新历史数据
    :param get_tencent_data: 从腾讯疫情获取的数据
    :param get_connect_ret: 获取链接和游标
    :param close_conn: 关闭游标和链接
    :return:none
    """
    cursor = None
    conn = None
    try:
        dic = get_tencent_data()[0]  # 历史字典数据
        print(f"{time.asctime()}开始更新历史数据")
        conn, cursor = get_connect_ret  # 返回值元组
        sql = "insert into history values(%s,%s,%s,%s,%s,%s,%s,%s,%s)"  # 9个
        sql_query = "select confirm from history where ds=%s"
        for k, v in dic.items():
            if not cursor.execute(sql_query, k):
                cursor.execute(sql, [k, v.get("confirm"), v.get("confirm_add"), v.get("suspect"), v.get("suspect_add"),
                                     v.get("heal"), v.get("heal_add"), v.get("dead"), v.get("dead_add")])
        conn.commit()  # 提交事务
        print(f"{time.asctime()}历史数据更新完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(conn, cursor)
```

## 2.3 爬取百度热搜数据

### 2.3.1分析与处理

预案是使用selenium来获取数据,

因为原来是异步加载的信息,

但是现在忽然变成静态网页了,

所以我们使用`requests`结合`xpath`获取热词

#### 数据的获取

```python
def get_baidu_data():
    url = "https://top.baidu.com/board"
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:100.0) Gecko/20100101 Firefox/100.0",
    }
    params = {
        "tab": "realtime",
    }
    response = requests.get(url=url, headers=headers, params=params)
    obj_title = re.compile(r'<div class="c-single-text-ellipsis">(?P<title>.*?)</div>'
                           r'.*?<div class="hot-index_1Bl1a">(?P<number>.*?)</div>', re.S)
    titles = obj_title.finditer(response.text)
    lst = []
    for title in titles:
        data = title.group("title") + title.group("number")
        lst.append(data.replace(' ', ''))
    response.close()
```



### 2.3.2 数据永久化

#### 1. 创建对应数据表

```sql
CREATE TABLE `hotsearch` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `dt` datetime DEFAULT NULL ON UPDATE current_timestamp(),
  `content` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
```

#### 2.Python链接数据库

配置说明可见上文

```python
def get_connect(link_conf):
    """
    传入用户的数据库配置,返回一个链接和游标
    :param link_conf:
    :return: (链接,游标)
    """

    # 创建链接
    connect = pymysql.connect(host=link_conf["host"],
                              port=link_conf["port"],
                              user=link_conf["user"],
                              password=link_conf["password"],
                              db=link_conf["db"],
                              charset=link_conf["charset"])
    # 创建游标
    cursor = connect.cursor()
    return connect, cursor


def close_connect(conn, csr):
    """
    传入将链接和游标进行顺序关闭
    :param conn: 链接
    :param csr: 游标
    :return: none
    """
    if csr:
        csr.close()
    if conn:
        conn.close()

        
link_config = {
    "host": "127.0.0.1",
    "port": 3306,
    "user": "root",
    "password": "***********",
    "db": "bugsong",
    "charset": "utf8mb4"
}
```

#### 3.Python写入数据

由于热搜变化快,我们在此不再进行重复验证,直接获取数据后存入数据库即可

```python
def update_hotsearch(get_baidu_data, get_connect_ret, close_conn):
    cursor = None
    conn = None
    try:
        context = get_baidu_data()  # 承接百度返回的数据
        print(f"{time.asctime()}开始更新热搜数据")
        conn, cursor = get_connect_ret  # 返回值元组
        sql = "insert into hotsearch(dt,content) values (%s,%s)"  # 指定列数句
        ts = time.strftime("%Y-%m-%d %X")
        for i in context:
            cursor.execute(sql, (ts, i))  # 插入数据
        conn.commit()  # 提交事务
        print(f"{time.asctime()}热搜数据更新完毕")
    except:
        traceback.print_exc()
    finally:
        close_conn(conn, cursor)
```



# 三 Web程序开发

## 3.1 快速入门Flask

- Flask是一个使用Python编写的轻量级Web应用框架
- 其中的WSGI工具包采用Werkzeug
- 模板引擎则使用Jinja2
- 是目前十分流行的Web框架之一

### 使用ajax实现局部刷新

- 使用jquery框架简化ajax请求写法

- 写法示例:

```javascript
$.ajax({
    type:"post",  // 请求类型
    url:"/目标路由",  // 请求地址
    data:{"k1":"v1","k2":"v2"},  // 数据
    datatype:"json",  // 返回的数据类型
    success:function(datas){
    	// 请求成功的回调函数,datas是返回的数据
	},
    error:fuction(){
        // 请求失败时执行
    }
})
```

- 可以通过本地加载jquery文件实现渲染提速,所以我们先去下载一个jquery.js放置在本地目录中

  - https://www.bootcdn.cn/jquery/

- 组织结构如下

  - ![image-20220525182810099](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220525182810099.png)

- app.py部分

  - ```python
    @app.route('/ajax', methods=["get", "post"])
    def ajax_():
        name = request.values.get("name")
        score = request.values.get("score")
        print(f"name:{name},score:{score}")
        return "10000"
    ```

- index.html部分

  - ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>My Page</title>
        <script src="../static/js/jquery-3.6.0.min.js"></script>
    </head>
    <body>
    <h1>疫情追踪</h1>
    <h3>实时报道</h3>
    <button>点我替换</button>
    <script>
        $("button").click(function () {
            $.ajax({
                url: "/ajax",
                type: "post",
                data: {"name": "里斯", "score": "99"},
                success: function (d) { //随手定义一个d表示传过来的数据,就是这么帅
                    $("h1").html("感染人数" + d)
                },
                error: function () {
                    alert("发送ajax请求失败")
                }
            })
        })
    </script>
    </body>
    </html>
    ```

  - 效果展示

    - ![image-20220525183021931](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220525183021931.png)
    - ![image-20220525183040003](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220525183040003.png)
    - ![image-20220525183057818](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220525183057818.png)

## 3.2 可视化大屏模板制作

### 3.2.1 使用结对定位划分板块

涉及到Web的CSS部分知识点

1. 绝对布局
2. 相对大小

#### 调整前端配置

#### 获取后端数据

### 3.2.2 Echarts的使用

#### 下载Echarts源码

**下载链接:**https://github.com/apache/echarts/releases/tag/5.3.2

下载指示

![image-20220526093301291](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220526093301291.png)

#### 引入我们的项目

![image-20220526095536875](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220526095536875.png)

### 3.2.3 绘制中国地图部分

#### 调整前端配置

1. 创建中国地图option

   1. 模板已经没有了,也没有找打,以下全为手打

   2. ```javascript
      var ec_center_selector = echarts.init(document.getElementById("center_bottom"), "dark");
      var mydata = [{ 'name': '西藏', 'value': 318 }, { 'name': '新疆', 'value': 162 }];
      
      var ec_center_option = {
          title: {
              text: '',
              subtext: '',
              x: 'left',
          },
          tooltip: {
              trigger: 'item'
          },
          // 左侧小导航图标
          visualMap: {
              show: true,
              x: 'left',
              y: 'bottom',
              textStyle: {
                  fontSize: 8,
              },
              splitList: [{ start: 1, end: 9 },
              { start: 10, end: 99 },
              { start: 100, end: 999 },
              { start: 1000, end: 9999 },
              { start: 10000 }],
              color: ['#8A3310', '#c64918', '#E55B25', '#F2AD92', '#F9DCD1']
          },
          // 配置属性
          series: [{
              name: '累计确诊人数',
              type: 'map',
              mapType: 'china',
              roma: false,
              itemStyle: {
                  normal: {
                      borderWidth: 3,// 区域边框宽度
                      borderColor: '#4b0082',// 区域边框颜色
                      areaColor: '#ffefd5',// 区域颜色 
                  },
                  emphasis: { // 鼠标划过地图高亮相关
                      borderWidth: .5,
                      borderColor: '#4b0082',
                      areaColor: '#fff',
                  },
              },
              label: {
                  normal: {
                      show: true,//省份名称
                      fontSize: 10,
                  },
                  emphasis: {
                      show: true,
                      fontSize: 8,
                  }
              },
              data: mydata//数据
      
          }]
      };
      ec_center_selector.setOption(ec_center_option);
      ```

2. 设置承接数据脚本

   1. ```javascript
      // 地图数据部分
      function get_center_bottom_data() {
          $.ajax({
              url: "/center_bottom",
              success: function (data_json_value) {
                  ec_center_option.series[0].data = data_json_value.data;//从后台拿到数据
                  ec_center_selector.setOption(ec_center_option);//丢在option里面重新渲染
              },
              error: function () {
      
              }
          })
      }
      get_center_bottom_data();//仅调用一次
      ```

#### 获取后端数据

**app.py**

```python
def get_center_bottom_data(get_conn_tup):
    _tup = get_conn_tup
    sql = "select province,sum(confirm) from details " \
          "where update_time=(select update_time from details " \
          "order by update_time desc limit 1) " \
          "group by province"
    res = query(sql=sql, get_conn_tup=_tup)
    return res
```

**app.py**

```python
@app.route('/center_bottom')
def get_center_bottom_data():
    tup = utils.get_connect(utils.link_config)
    data = utils.get_center_bottom_data(tup)
    print(data)
    res = []
    for tup_ in data:
        res.append({"name": tup_[0], "value": int(tup_[1])})
        # 处理成前端对应的格式
    return jsonify({"data": res})

```

**渲染成功图**

![image-20220526114535296](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220526114535296.png)

### 3.2.4 堆叠着线图部分

#### 调整前端配置

此部分位于左区域上下两个部分,在此一并实现,以下是实现各个功能的代码

- **javascript**

```javascript
var ec_left_top_selector = echarts.init(document.getElementById("left_top"), "dark");

var ec_left_top_option = {
    //标题样式
    title: {
        text: '全国累计趋势',
        left: 'left',
    },



    tooltip: {
        trigger: 'axis',
        //指示器
        axisPointer: {
            type: 'line',
            lineStyle: {
                color: "#7171C6",
            }
        },
    },
    legend: {
        data: ['累计确诊', '现有疑似', '累计治愈', '累计死亡'],
        left: "right",
    },

    //图形位置
    grid: {
        left: '4%',
        right: '6%',
        bottom: '4%',
        top: 50,//暂时没打%
        containLabel: true
    },
    xAxis: [{
        type: 'category',
        // boundaryGap: false,
        // nothing,just 王义松
        data: ['01.20', '01.21', '01.22']
    }],
    yAxis: [{
        type: 'value',
        //y轴字体设置
        axisLabel: {
            show: true,
            color: 'white',
            fontSize: 12,
            formatter: function (value) {
                if (value >= 1000) {
                    value = value / 1000 + 'k';
                }
                return value;
            }
        },
        //y轴线设置
        axisLine: {
            show: true,
        },
        splitLine: {
            show: true,
            lineStyle: {
                color: '#17273B',
                width: 1,
                type: 'solid',
            }

        }
    }],
    series: [
        {
            name: '累计确诊',
            type: 'line',
            smooth: true,
            data: [120, 132, 101]
        },
        {
            name: '现有疑似',
            type: 'line',
            smooth: true,
            data: [33, 16, 91]
        },
        {
            name: '累计治愈',
            type: 'line',
            smooth: true,
            data: [45, 37, 86]
        },
        {
            name: '累计死亡',
            type: 'line',
            smooth: true,
            data: [38, 43, 11]
        },
    ]
};
ec_left_top_selector.setOption(ec_left_top_option);

//下部分
var ec_left_bottom_selector = echarts.init(document.getElementById("left_bottom"), "dark");

var ec_left_bottom_option = {
    //标题样式
    title: {
        text: '全国新增趋势',
        left: 'left',
    },

    tooltip: {
        trigger: 'axis',
        //指示器
        axisPointer: {
            type: 'line',
            lineStyle: {
                color: "#7171C6",
            }
        },
    },
    legend: {
        data: ['新增确诊', '新增疑似'],
        left: "right",
    },

    //图形位置
    grid: {
        left: '4%',
        right: '6%',
        bottom: '4%',
        top: 50,//暂时没打%
        containLabel: true
    },
    xAxis: [{
        type: 'category',
        // boundaryGap: false,
        // nothing,just 王义松
        data: ['01.20', '01.21', '01.22']
    }],
    yAxis: [{
        type: 'value',
        //y轴字体设置
        axisLabel: {
            show: true,
            color: 'white',
            fontSize: 12,
            formatter: function (value) {
                if (value >= 1000) {
                    value = value / 1000 + 'k';
                }
                return value;
            }
        },
        //y轴线设置
        axisLine: {
            show: true,
        },
        splitLine: {
            show: true,
            lineStyle: {
                color: '#17273B',
                width: 1,
                type: 'solid',
            }

        }
    }],
    series: [
        {
            name: '新增确诊',
            type: 'line',
            smooth: true,
            data: [120, 132, 101]
        },
        {
            name: '新增疑似',
            type: 'line',
            smooth: true,
            data: [33, 16, 91]
        },
    ]
};
ec_left_bottom_selector.setOption(ec_left_bottom_option);
```

- **调用**

```javascript
//左上部分
function get_left_top_data() {
    $.ajax({
        url: "/left_top",
        success: function (data_json_value) {
            ec_left_top_option.xAxis[0].data = data_json_value.day
            ec_left_top_option.series[0].data = data_json_value.confirm
            ec_left_top_option.series[1].data = data_json_value.suspect
            ec_left_top_option.series[2].data = data_json_value.heal
            ec_left_top_option.series[3].data = data_json_value.dead
            ec_left_top_selector.setOption(ec_left_top_option);//丢在option里面重新渲染
        },
        error: function () {
            alert("没拿到后台数据");
        }
    })
}
get_left_top_data();
// 左下部分
function get_left_bottom_data() {
    $.ajax({
        url: "/left_bottom",
        success: function (data_json_value) {
            ec_left_bottom_option.xAxis[0].data = data_json_value.day
            ec_left_bottom_option.series[0].data = data_json_value.confirm_add
            ec_left_bottom_option.series[1].data = data_json_value.suspect_add

            ec_left_bottom_selector.setOption(ec_left_bottom_option);//丢在option里面重新渲染
        },
        error: function () {
            alert("没拿到后台数据");
        }
    })
}
get_left_bottom_data();
```

#### 获取后端数据

**返回值部分定义**

```python
@app.route('/left_top')
def get_left_top_data():
    tup = utils.get_connect(utils.link_config)
    data = utils.get_left_top_data(tup)
    day, confirm, suspect, heal, dead = [], [], [], [], []
    for d, c, s, h, de in data[7:]:  # 去掉公布的完的Null数据
        day.append(d.strftime("%m-%d"))  # d是datetime类型
        confirm.append(c)
        suspect.append(s)
        heal.append(h)
        dead.append(de)
        # 处理成前端对应的格式
    json_ = {
        "day": day,
        "confirm": confirm,
        "suspect": suspect,
        "heal": heal,
        "dead": dead,
    }
    return jsonify(json_)


@app.route('/left_bottom')
def get_left_bottom_data():
    tup = utils.get_connect(utils.link_config)
    data = utils.get_left_bottom_data(tup)
    day, confirm_add, suspect_add = [], [], []
    for d, c, s in data[7:]:
        day.append(d.strftime("%m-%d"))
        confirm_add.append(c)
        suspect_add.append(s)
        # 处理成前端对应的格式
    json_ = {
        "day": day,
        "confirm_add": confirm_add,
        "suspect_add": suspect_add,
    }
    return jsonify(json_)
```

**工具包函数定义**

```python
def get_left_top_data(get_conn_tup):
    _tup = get_conn_tup
    sql = "select ds,confirm,suspect,heal,dead from history"
    res = query(sql=sql, get_conn_tup=_tup)
    return res


def get_left_bottom_data(get_conn_tup):
    _tup = get_conn_tup
    sql = "select ds,confirm_add,suspect_add from history"
    res = query(sql=sql, get_conn_tup=_tup)
    return res

```

**注:由于腾讯关闭了历史数据的部分接口,我们目前仅能获取到最新新增统计,而拿不到历史数据,但是功能是完全没有问题的**

![image-20220526132821002](/home/whyiss/Disk1/Markdown/毕业设计.assets/image-20220526132821002.png)

### 3.2.5 柱形图以及热搜词云部分

#### 调整前端配置

#### 获取后端数据

# 四 项目部署







































